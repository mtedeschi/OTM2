{% extends "base.html" %}
{% load i18n %}
{% load instance_config %}
{% load form_extras %}

{% block application_css %}
{% if request.instance.scss_variables %}
<link id="application-css" href="{% url 'scss' %}?{{ request.instance.scss_query_string }}" rel="stylesheet">
{% elif settings.DEBUG %}
<link id="application-css" href="{{ STATIC_URL }}css/main.css" rel="stylesheet">
{% else %}
<link id="application-css" href="{{ STATIC_URL }}css/main.min.css" rel="stylesheet">
{% endif %}
{% endblock application_css %}

{% block instance_title %} | {{ request.instance.name }}{% endblock %}

{% block instancetopnav %}
{% if request.instance|feature_enabled:'add_plot' and last_effective_instance_user %}
  {% if request.instance.supports_resources %}
    <li class="add-menu dropdown" data-feature="add_plot">
      <a class="dropdown-toggle" data-toggle="dropdown"
         data-always-enable="true"
         data-disabled-title='{% trans "Adding trees is not available to all users" %}'
         disabled='disabled'>
        <i class="icon-plus-circled"></i>
      </a>
      <ul class="dropdown-menu">
        <li>
          <a data-href="{% url 'map' instance_url_name=request.instance.url_name %}?m=addTree"
             data-always-enable="{{ last_effective_instance_user|plot_is_writable }}"
             data-action='addtree'>{% trans "Add a Tree" %}</a>
        </li>
        <li>
          <a data-href="{% url 'map' instance_url_name=request.instance.url_name %}?m=addResource"
             data-always-enable="{{ last_effective_instance_user|plot_is_writable }}"
             data-action='addresource'>{% trans "Add a" %} {{ term.Resource }}</a>
        </li>
      </ul>
    </li>
  {% else %}
    <li data-feature="add_plot">
      <a data-action='addtree'
         data-always-enable='{{ last_effective_instance_user|plot_is_writable }}'
         data-disabled-title='{% trans "Adding trees is not available to all users" %}'
         data-href="{% url 'map' instance_url_name=request.instance.url_name %}?m=addTree"
         disabled='disabled'>{% trans "Add a Tree" %}</a>
    </li>
  {% endif %}
{% endif %}
<li class="explore-map {% block activeexplore %}active{% endblock %}"><a href="{% url 'map' instance_url_name=request.instance.url_name %}">{% trans "Explore Map" %}</a></li>
{% if request.instance|feature_enabled:'recent_edits_report' %}
<li class="{% block activerecentedits %}{% endblock %}">
  <a href="{% url 'edits' instance_url_name=request.instance.url_name %}">{% trans "View Edits" %}</a>
</li>
{% endif %}
{% if settings.MANAGEMENT_VIEW_NAME and last_effective_instance_user.admin %}
<li class="{% block activemanagement %}{% endblock %}">
  <a href="{% url settings.MANAGEMENT_VIEW_NAME instance_url_name=request.instance.url_name %}">{% trans "Manage" %}</a>
</li>
{% endif %}
{% endblock instancetopnav %}

{% block signup %}
<li>
  <a href="{% url 'instance_registration_register' instance_url_name=request.instance.url_name %}">{% trans "Sign Up" %}</a>
</li>
{% endblock signup %}

{% block subhead %}
<div class="subhead">
  {% with advanced_search_fields=request.instance.advanced_search_fields %}
  <div class="advanced-search">
    <div class="container">
      <div class="row-fluid">
        <div class="span6">
          <h4>{% trans "Detail Filters" %}</h4>
          {% for json in request.instance.advanced_search_fields.standard %}
            {% search from json for request.user in request.instance withtemplate "treemap/field/search.html" %}
          {% endfor %}
        </div>
        <div class="span3" id="display-filters" data-search-type="IN"
            data-search-identifier="mapFeature.feature_type">
          <h4>{% trans "Display Filters" %}</h4>
          {% for field in request.instance.advanced_search_fields.display %}
            {% include "treemap/partials/display_filters.html" %}
          {% endfor %}
        </div>
        <div class="span3">
          <h4>{% trans "Missing Data" %}</h4>
          {% for json in request.instance.advanced_search_fields.missing %}
            {% search from json for request.user in request.instance withtemplate "treemap/field/search.html" %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  {% with stewardship=advanced_search_fields.udfc.stewardship %}
  {% with alerts=advanced_search_fields.udfc.alerts %}
  {% if stewardship or alerts %}
  {% with tree_stewardship_perm_level=last_effective_instance_user|udf_write_level:stewardship.tree.udfd %}
  {% with plot_stewardship_perm_level=last_effective_instance_user|udf_write_level:stewardship.plot.udfd %}
  {% if tree_stewardship_perm_level|is_read_or_write or plot_stewardship_perm_level|is_read_or_write or tree_alerts_perm_level|is_read_or_write or plot_alerts_perm_level|is_read_or_write %}
  <div class="udfc-search">
    <span>{% trans "I am looking for" %}</span>
    <label class="udfc-label">
        <select id="udfc-search-model">
          <option data-class="udfc-placeholder" selected />
          {% if tree_stewardship_perm_level|is_read_or_write or tree_alerts_perm_level|is_read_or_write %}
          {% if stewardship.tree.fields or alerts.tree.fields %}
          <option data-model="tree">{% trans "trees" %}</option>
          {% endif %}
          {% endif %}
          {% if plot_stewardship_perm_level|is_read_or_write or plot_alerts_perm_level|is_read_or_write %}
          {% if stewardship.plot.fields or alerts.plot.fields %}
          <option data-model="plot">{% trans "plots" %}</option>
          {% endif %}
          {% endif %}
        </select>
    </label>

    <label class="udfc-label">
        <select id="udfc-search-type">
          <option data-class="udfc-placeholder" selected />
          {% if stewardship %}
          <option data-type="stewardship"
                  data-plot-udfd-id="{{ stewardship.plot.udfd.pk }}"
                  data-tree-udfd-id="{{ stewardship.tree.udfd.pk }}"
                  data-date-field-key="Date"
                  data-action-field-key="Action"
                  >{% trans "that received" %}</option>
          {% endif %}
          {% if alerts %}
          <option data-type="alerts"
                  data-plot-udfd-id="{{ alerts.plot.udfd.pk }}"
                  data-tree-udfd-id="{{ alerts.tree.udfd.pk }}"
                  data-date-field-key="Date Noticed"
                  data-action-field-key="Action Needed"
                  >{% trans "that need" %}</option>
          {% endif %}
        </select>
    </label>

    
    <div id="udfc-extra-clauses" style="display: none">
      <input id="alerts-resolved"
             data-type="alerts"
             data-field="Status"
             data-search-type="IS"
             value="Unresolved"/>
    </div>
    

    <label class="udfc-label">
        <select id="udfc-search-action" data-search-type="IS">
          <option data-class="udfc-placeholder" selected />
          {% for action in stewardship.tree.fields %}
          <option data-model="tree" data-type="stewardship" style="display: none;">{{ action }}</option>
          {% endfor %}
          {% for action in alerts.tree.fields %}
          <option data-model="tree" data-type="alerts" style="display: none;">{{ action }}</option>
          {% endfor %}
          {% for action in stewardship.plot.fields %}
          <option data-model="plot" data-type="stewardship" style="display: none;">{{ action }}</option>
          {% endfor %}
          {% for action in alerts.plot.fields %}
          <option data-model="plot" data-type="alerts" style="display: none;">{{ action }}</option>
          {% endfor %}
        </select>
    </label>

    <span>{% trans "between" %}</span>
    <input id="udfc-search-date-from" data-search-type="MIN"
           class="stewardship-selector"
           {% include "treemap/partials/date_picker_init.html" %}
           />
    <span>{% trans "and" %}</span>
    <input id="udfc-search-date-to" data-search-type="MAX"
           class="stewardship-selector"
           {% include "treemap/partials/date_picker_init.html" %}
           />

  </div>
  {% endif %}
  {% endwith %}
  {% endwith %}
  {% endif %}
  {% endwith %}
  {% endwith %}

  <div class="stats-bar">
    <div style="display: inline;" id="tree-and-planting-site-counts">
    </div>
    {% block subhead_exports %}
      {% if request.instance|feature_enabled:'exports' %}
      <a href="javascript:;" class="btn btn-primary btn-mini exportBtn" id="exportbutton">
        <i class="icon-export"></i> {% trans "Export Search Results" %}
      </a>
      {% endif %}
    {% endblock subhead_exports %}
    {% if request.instance|feature_enabled:'add_plot' and last_effective_instance_user %}
      {% if request.instance.supports_resources %}
      <a class="btn btn-primary addBtn"
         data-action='addresource'
         data-feature="add_plot"
         data-always-enable="{{ last_effective_instance_user|plot_is_writable }}"
         data-disabled-title=
           "{% blocktrans with resources=terms.resources %}Adding {{ resources }} is not available to all users {% endblocktrans %}"
         data-href="{% url 'map' instance_url_name=request.instance.url_name %}?m=addResource"
         disabled="disabled"><i class="icon-plus"></i> {% trans "Add a" %} {{ term.Resource }}</a>
      {% endif %}
    <a class="btn btn-primary addBtn"
       data-action='addtree'
       data-feature="add_plot"
       data-always-enable="{{ last_effective_instance_user|plot_is_writable }}"
       data-disabled-title="{% trans "Adding trees is not available to all users" %}"
       data-href="{% url 'map' instance_url_name=request.instance.url_name %}?m=addTree"
       disabled="disabled"><i class="icon-plus"></i> {% trans "Add a Tree" %}</a>
    {% endif %}
  </div>
  {% endwith %}
</div>
{% endblock subhead %}

{% block export %}
<div id="export-panel" class="modal hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h2></h2>
  </div>
  <div class="modal-body">
    <span class="prep-msg">{% trans "Preparing your export..." %}</span>
    <span style="display: none;" class="error-msg">{% trans "There was  an error while generating your export. Please try again later." %}</span>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn dismiss-cancel" data-dismiss="modal">{% trans "Cancel" %}</a>
    <a style="display: none;" href="#" class="btn dismiss-ok" data-dismiss="modal">{% trans "OK" %}</a>
  </div>
</div>
{% endblock export %}

{% block search %}
{% include "treemap/partials/search_bar.html" %}
{% endblock search %}

{% block searchoptions %}
<div class="search-options">
  <a id="perform-search" class="btn btn-primary btn-large btn-block">{% trans "Search" %}</a>
  <div class="btn-group">
    {% if request.instance|feature_enabled:'advanced_search_filters' %}
    <button id="search-advanced" class="btn">{% trans "Advanced" %}</button>
    <button id="search-reset" class="btn">{% trans "Reset" %}</button>
    {% else %}
    <button id="search-reset" class="btn btn-block">{% trans "Reset" %}</button>
    {% endif %}
  </div>
</div>
{% endblock searchoptions %}

{% block exportscript %}
<script type="text/javascript">
    (function(require) {
        require('treemap/export').init({
            trigger: '#exportbutton',
            panel: '#export-panel',
            cancel: '#export-panel * [data-dismiss]',
            startTreeExportUrl: '{% url 'start_export' instance_url_name=request.instance.url_name model='tree' %}',
            checkTreeExportUrl: '{{ SITE_ROOT }}{{ request.instance.url_name }}/export/check'
        });
    })(require);
</script>
{% endblock exportscript %}

{% block searchscripts %}
<script type="text/javascript">
    (function(require) {
        require("treemap/searchBar").initDefaults(otm.settings);
    })(require);
</script>
{% endblock searchscripts %}

{% block footer %}
<div class="footer-inner">
  {% with linkData=request.instance|instance_config:"linkData" %}
  <ul class="inline pull-left">
    <li><a target="_blank"
           {% if 'treekey' in linkData.keys and linkData.treekey %}
           href="{{ linkData.treekey }}"
           {% else %}
           href="http://www.arborday.org/trees/whatTree/"
           {% endif %}
           >{% trans "Tree Key" %}</a></li>
    {% for name in request.instance.static_page_names %}
    <li><a href="{% url 'static_page' instance_url_name=request.instance.url_name page=name %}">{{ name }}</a></li>
    {% endfor %}
  </ul>
  {% if 'contact' in linkData.keys and linkData.contact %}
  <a href="mailto:{{ linkData.contact }}" class="pull-right partners">{% trans "Contact" %}</a>
  {% endif %}
{% endwith %}
</div>
{% endblock footer %}

{% block templates %}
{% verbatim %}
<script id="species-element-template" type="text/x-mustache-template">
  <p>{{common_name}}</p>
  <p>{{scientific_name}}</p>
</script>
<script id="boundary-element-template" type="text/x-mustache-template">
  <p>{{name}}</p>
  <p>{{category}}</p>
</script>

<script id="geocode-results-template" type="text/x-mustache-template">
<ul class="unstyled">
{{#candidates}}
<li><a href="javascript:;" data-class="geocode-result" data-x="{{x}}" data-y="{{y}}" data-srid="{{srid}}" data-address"{{address}}">{{address}}</a></li>
{{/candidates}}
</ul>
</script>

{% endverbatim %}
{% endblock templates %}
